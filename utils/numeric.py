"""Утилиты для преобразования слов в числа (0–59) и разбора одного числа из текста."""

import re
from typing import Optional

# Общий словарь: одиночные слова и пары (двадцать одна, тридцать две и т.п.).
# Включены «одна», «две», «раз» для parse_number (мангулы и т.п.).
NUMBERS = {
    "ноль": 0,
    "один": 1, "одна": 1, "раз": 1,
    "два": 2, "две": 2,
    "три": 3,
    "четыре": 4,
    "пять": 5,
    "шесть": 6,
    "семь": 7,
    "восемь": 8,
    "девять": 9,
    "десять": 10,
    "одиннадцать": 11,
    "двенадцать": 12,
    "тринадцать": 13,
    "четырнадцать": 14,
    "пятнадцать": 15,
    "шестнадцать": 16,
    "семнадцать": 17,
    "восемнадцать": 18,
    "девятнадцать": 19,
    "двадцать": 20,
    "двадцать одна": 21, "двадцать один": 21,
    "двадцать две": 22, "двадцать два": 22,
    "двадцать три": 23,
    "двадцать четыре": 24,
    "двадцать пять": 25,
    "двадцать шесть": 26,
    "двадцать семь": 27,
    "двадцать восемь": 28,
    "двадцать девять": 29,
    "тридцать": 30,
    "тридцать одна": 31, "тридцать один": 31,
    "тридцать две": 32, "тридцать два": 32,
    "тридцать три": 33,
    "тридцать четыре": 34,
    "тридцать пять": 35,
    "тридцать шесть": 36,
    "тридцать семь": 37,
    "тридцать восемь": 38,
    "тридцать девять": 39,
    "сорок": 40,
    "сорок один": 41, "сорок одна": 41,
    "сорок два": 42, "сорок две": 42,
    "сорок три": 43,
    "сорок четыре": 44,
    "сорок пять": 45,
    "сорок шесть": 46,
    "сорок семь": 47,
    "сорок восемь": 48,
    "сорок девять": 49,
    "пятьдесят": 50,
    "пятьдесят один": 51, "пятьдесят одна": 51,
    "пятьдесят два": 52, "пятьдесят две": 52,
    "пятьдесят три": 53,
    "пятьдесят четыре": 54,
    "пятьдесят пять": 55,
    "пятьдесят шесть": 56,
    "пятьдесят семь": 57,
    "пятьдесят восемь": 58,
    "пятьдесят девять": 59,
}


def words_to_numbers(text: str) -> str:
    """
    Заменяет числительные (слова и пары вроде «двадцать одна») на цифры в строке.
    Сначала проверяются двухсловные пары, затем одиночные.
    """
    words = text.lower().split()
    result = []
    i = 0
    while i < len(words):
        if i + 1 < len(words):
            pair = f"{words[i]} {words[i+1]}"
            if pair in NUMBERS:
                result.append(str(NUMBERS[pair]))
                i += 2
                continue
        if words[i] in NUMBERS:
            result.append(str(NUMBERS[words[i]]))
        else:
            result.append(words[i])
        i += 1
    return " ".join(result)


def parse_number(text: str) -> Optional[int]:
    """
    Извлекает одно число из строки: либо цифры, либо слово/пара слов из NUMBERS.
    Возвращает первое найденное число или None.
    """
    t = text.strip().lower()
    # 1) Цифры в строке
    digits = "".join(c for c in t if c.isdigit())
    if digits:
        return int(digits)
    # 2) Слова: сначала пары, потом одиночные
    replaced = words_to_numbers(t)
    m = re.search(r"\d+", replaced)
    if m:
        return int(m.group(0))
    return None
